---
#
# Create a heirarchical directory derived from the groups/regions this device
# is a part of.  This can be set via the mdd_dir_items variable with a default
# in the role.
#
- include_role:
    name: ciscops.mdd.common
    tasks_from: files_in_path
  vars:
    mdd_file_patterns: "{{ mdd_data_patterns }}"

- name: Define file_list_dict
  set_fact:
    file_list_dict: []

- name: Add all files to a list
  set_fact:
    file_list_dict: "{{ file_list_dict + file }}"
  loop: "{{ mdd_file_list }}"
  vars:
    file: "{{ lookup('template', item ) | from_yaml_all }}"

# Merge in the data from the file if the tags match with the host (or are not specified)
# We now have to call a module, because nested loops in ansible are messy
# and not good for dealing with merged files (oc-*.yml with multiple files in it, each denoted by - - -)
- name: Gather the MDD Data
  gather_mdd_data:
    mdd_file_data: "{{ file_list_dict }}"
    tags: "{{ tags }}"
  register: result

- name: Set mdd_data_list
  set_fact:
    mdd_data_list: "{{ result.mdd_data }}"

- name: Combine the MDD Data
  set_fact:
    mdd_data: "{{ mdd_data_list | ciscops.mdd.mdd_combine(recursive=True) }}"
  when: mdd_data_list is defined

- include_tasks: netbox.yml
  when: netbox_api is defined or lookup('env', 'NETBOX_API', default=false)
